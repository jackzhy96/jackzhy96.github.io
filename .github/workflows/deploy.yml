# GitHub Actions workflow for building and deploying Jekyll site with private analytics
name: Deploy Jekyll Site

on:
  push:
    branches: ["master"]
  workflow_dispatch:  # Allows manual trigger from Actions tab

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    environment: github-pages  # Required to access environment secrets
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: true

      - name: Setup Pages
        uses: actions/configure-pages@v4

      # Inject the analytics tracking ID from secrets
      # Uses a placeholder pattern for reliable replacement
      - name: Inject Analytics Tracking ID
        env:
          GA_TRACKING_ID: ${{ secrets.GA_TRACKING_ID }}
        run: |
          PLACEHOLDER="__GA_TRACKING_ID_PLACEHOLDER__"

          # Check if analytics provider is disabled
          if grep -q 'provider: "false"' _config.yml || grep -q "provider: false" _config.yml; then
            echo "Analytics provider is disabled, skipping injection"
            # Remove placeholder to avoid it appearing in output
            sed -i "s/$PLACEHOLDER//" _config.yml
            exit 0
          fi

          # Trim any whitespace from the tracking ID
          GA_TRACKING_ID=$(echo "$GA_TRACKING_ID" | tr -d '[:space:]')

          # Validate tracking ID is set
          if [ -z "$GA_TRACKING_ID" ]; then
            echo "::error::GA_TRACKING_ID secret is not set in github-pages environment!"
            echo "Please add it at: Settings > Environments > github-pages > Add secret"
            exit 1
          fi

          # Validate tracking ID format (G-XXXXXXXXXX or UA-XXXXXXXX-X)
          if [[ ! "$GA_TRACKING_ID" =~ ^(G-[A-Z0-9]+|UA-[0-9]+-[0-9]+)$ ]]; then
            echo "::error::Invalid tracking ID format: $GA_TRACKING_ID"
            echo "Expected format: G-XXXXXXXXXX (GA4) or UA-XXXXXXXX-X (Universal)"
            exit 1
          fi

          # Check placeholder exists before replacement
          if ! grep -q "$PLACEHOLDER" _config.yml; then
            echo "::error::Placeholder '$PLACEHOLDER' not found in _config.yml"
            echo "Please ensure tracking_id is set to '$PLACEHOLDER' in _config.yml"
            exit 1
          fi

          # Replace placeholder with actual tracking ID
          sed -i "s/$PLACEHOLDER/$GA_TRACKING_ID/g" _config.yml

          # Verify the replacement worked
          if grep -q "$GA_TRACKING_ID" _config.yml; then
            echo "âœ“ Analytics tracking ID injected successfully"
            echo "  Format: ${GA_TRACKING_ID:0:2}-XXXXXX (${#GA_TRACKING_ID} chars)"
          else
            echo "::error::Failed to inject tracking ID into _config.yml"
            exit 1
          fi

      - name: Build with Jekyll
        run: bundle exec jekyll build
        env:
          JEKYLL_ENV: production

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
